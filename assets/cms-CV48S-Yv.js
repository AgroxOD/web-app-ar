import"./style-Yv-X3phN.js";import{login as k,setAuth as E,register as x,logout as M,isAuthenticated as L,getRole as h}from"./auth-5C6X5tix.js";import{updateModel as C,loadModels as N,deleteModel as T}from"./models-BPT0YZdd.js";function D(e,a,s,r){const t=document.createElement("form");t.className="inline-form";const o=document.createElement("input");o.className="text-input",o.name="name",o.required=!0,o.value=s.name;const n=document.createElement("input");n.className="text-input",n.name="markerIndex",n.type="number",n.required=!0,n.value=s.markerIndex;const l=document.createElement("button");l.className="button button-primary",l.type="submit",l.textContent="Save";const c=document.createElement("button");return c.className="button",c.type="button",c.textContent="Cancel",t.append(o,n,l,c),c.addEventListener("click",()=>{t.remove(),r.disabled=!1}),t.addEventListener("submit",async b=>{b.preventDefault();try{await C(a,{name:t.name.value,markerIndex:parseInt(t.markerIndex.value,10)||0}),window.showMessage&&window.showMessage("Model updated"),window.refreshModels&&await window.refreshModels()}catch(w){if(window.showMessage){const B=w.message==="Forbidden"?"Permission denied":w.message;window.showMessage(B||"Update failed",!0)}}}),r.disabled=!0,e.appendChild(t),t}const p=document.getElementById("login-form"),g=document.getElementById("register-form"),v=document.getElementById("logout"),F=document.getElementById("show-register"),A=document.getElementById("show-login"),I=document.getElementById("upload-form"),$=document.getElementById("upload-section"),y=document.getElementById("models-list");let d=document.getElementById("message");d||(d=document.createElement("div"),d.id="message",document.body.prepend(d));let u=!1;function i(e,a=!1){d&&(d.textContent=e,d.className=a?"p-2 bg-red-200 text-red-800":"p-2 bg-green-200 text-green-800",d.style.display="block",clearTimeout(d._hideTimer),e&&(d._hideTimer=setTimeout(()=>{d.textContent="",d.className="",d.style.display="none"},4e3)))}window.showMessage=i;function m(){const e=L();e?(p.style.display="none",g.style.display="none"):u?(p.style.display="none",g.style.display="flex"):(p.style.display="flex",g.style.display="none"),v.style.display=e?"inline-block":"none",$.style.display=e&&h()==="admin"?"block":"none"}p.addEventListener("submit",async e=>{e.preventDefault();try{const{jwt:a,role:s}=await k(document.getElementById("login-email").value,document.getElementById("login-password").value);E(a,s),u=!1,m()}catch(a){i(a.message,!0)}});g.addEventListener("submit",async e=>{e.preventDefault();try{const{jwt:a,role:s}=await x(document.getElementById("register-username").value,document.getElementById("register-email").value,document.getElementById("register-password").value);E(a,s),u=!1,m()}catch(a){i(a.message,!0)}});v.addEventListener("click",()=>{M(),m()});F.addEventListener("click",()=>{u=!0,m()});A.addEventListener("click",()=>{u=!1,m()});async function S(e){e.preventDefault();const a=document.getElementById("upload-file").files[0],s=document.getElementById("upload-marker").value||"0";if(!a)return;const r="",t=localStorage.getItem("jwt"),o=new FormData;o.append("model",a),o.append("markerIndex",s);try{const n=await fetch(`${r}/upload`,{method:"POST",headers:t?{Authorization:`Bearer ${t}`}:{},body:o}),l=await n.json().catch(()=>({}));if(!n.ok)throw new Error(l.error||`Upload failed: ${n.status}`);i("Uploaded"),I.reset(),await f()}catch(n){i(n.message,!0)}}I.addEventListener("submit",S);function U(e){y.innerHTML="";const a=h()==="admin";e.forEach(s=>{const r=s._id,t=document.createElement("li");if(r&&(t.dataset.id=r),t.textContent=`${s.name} (${s.url}) - marker ${s.markerIndex}`,a&&r){const o=document.createElement("button");o.textContent="Edit",o.className="button button-primary ml-2",o.addEventListener("click",()=>D(t,t.dataset.id,s,o)),t.appendChild(o);const n=document.createElement("button");n.textContent="Delete",n.className="button button-secondary ml-2",n.addEventListener("click",async()=>{if(confirm("Delete this model?"))try{await T(t.dataset.id),i("Model deleted"),await f()}catch(l){i(l.message,!0)}}),t.appendChild(n)}y.appendChild(t)})}async function f(){y.innerHTML="<li>Loading...</li>";try{const e=await N();U(e)}catch(e){y.innerHTML="",i(e.message||"Failed to load models",!0)}}window.refreshModels=f;m();f();
