 */const Bfe={"tfjs-core":YR,"tfjs-backend-cpu":gA,"tfjs-backend-webgl":yA,"tfjs-data":mA,"tfjs-layers":ey,"tfjs-converter":aA,tfjs:$fe},Xfe=Object.freeze(Object.defineProperty({__proto__:null,Abs:vh,Acos:Jl,Acosh:ql,AdadeltaOptimizer:mv,AdagradOptimizer:gv,AdamOptimizer:yv,AdamaxOptimizer:bv,Add:Po,AddN:wh,All:jf,Any:Qf,ArgMax:Sh,ArgMin:Th,Asin:eu,Asinh:tu,Atan:nu,Atan2:ru,Atanh:su,AvgPool:Ih,AvgPool3D:_h,AvgPool3DGrad:qf,AvgPoolGrad:Jf,BatchMatMul:Mh,BatchToSpaceND:Ch,Bincount:em,BitwiseAnd:Eh,BroadcastArgs:tm,BroadcastTo:nM,Callback:tA,CallbackList:fC,Cast:iu,Ceil:au,ClipByValue:ou,Complex:nm,ComplexAbs:kh,Concat:Nh,Conv2D:Rh,Conv2DBackpropFilter:sm,Conv2DBackpropInput:Ah,Conv3D:Lh,Conv3DBackpropFilterV2:rm,Conv3DBackpropInputV2:im,Cos:lu,Cosh:uu,CropAndResize:om,Cumprod:am,Cumsum:Fh,CustomCallback:gC,DataStorage:Y0,DenseBincount:lm,DepthToSpace:um,DepthwiseConv2dNative:Dh,DepthwiseConv2dNativeBackpropFilter:cm,DepthwiseConv2dNativeBackpropInput:hm,Diag:dm,Dilation2D:Ph,Dilation2DBackpropFilter:ff,Dilation2DBackpropInput:pf,Draw:pm,get ENV(){return ex},EarlyStopping:nA,Einsum:fm,Elu:hu,EluGrad:mm,Environment:eM,Equal:Gh,Erf:du,Exp:pu,ExpandDims:Oh,Expm1:fu,FFT:gm,Fill:ym,FlipLeftRight:bm,Floor:mu,FloorDiv:gu,FromPixels:mf,FusedBatchNorm:zh,FusedConv2D:qc,FusedDepthwiseConv2D:eh,GPGPUContext:of,GatherNd:xm,GatherV2:Vh,GraphModel:tS,Greater:Wh,GreaterEqual:yu,History:mC,IFFT:vm,Identity:bu,Imag:wm,InputSpec:yn,IsFinite:xu,IsInf:vu,IsNan:wu,KernelBackend:Kf,LRN:Zh,LRNGrad:Tm,LayerVariable:cC,LayersModel:Ci,LeakyRelu:Uh,Less:$h,LessEqual:Bh,LinSpace:Sm,Log:Su,Log1p:Tu,LogSoftmax:sM,LogicalAnd:Xh,LogicalNot:Hh,LogicalOr:Kh,LogicalXor:TO,LowerBound:IO,MathBackendCPU:np,MathBackendWebGL:ap,MatrixBandPart:_O,Max:Yh,MaxPool:jh,MaxPool3D:Qh,MaxPool3DGrad:_m,MaxPoolGrad:Im,MaxPoolWithArgmax:Mm,Maximum:Iu,Mean:Jh,Min:qh,Minimum:_u,MirrorPad:ed,Mod:Mu,MomentumOptimizer:xv,Multinomial:Cm,Multiply:Cu,Neg:td,NonMaxSuppressionV3:Em,NonMaxSuppressionV4:km,NonMaxSuppressionV5:Nm,NotEqual:nd,OP_SCOPE_SUFFIX:ax,OneHot:rd,OnesLike:sd,Optimizer:Xi,OptimizerConstructors:S2,Pack:id,PadV2:ad,Pool:MO,Pow:Eu,Prelu:od,Prod:ld,RMSPropOptimizer:vv,RNN:Dr,RaggedGather:Rm,RaggedRange:Am,RaggedTensorToTensor:Lm,Range:Fm,get Rank(){return zb},Real:Dm,RealDiv:cu,Reciprocal:ku,get Reduction(){return rs},Relu:Nu,Relu6:Ru,Reshape:ud,ResizeBilinear:hd,ResizeBilinearGrad:Gm,ResizeNearestNeighbor:cd,ResizeNearestNeighborGrad:Pm,Reverse:dd,RotateWithOffset:eg,Round:Au,Rsqrt:Lu,SGDOptimizer:Pg,ScatterNd:Om,SearchSorted:Vm,Select:pd,Selu:Fu,Sequential:ty,Sigmoid:Ou,Sign:Gu,Sin:Du,Sinh:Pu,Slice:fd,Softmax:bd,Softplus:zu,SpaceToBatchND:gd,SparseFillEmptyRows:Wm,SparseReshape:Um,SparseSegmentMean:$m,SparseSegmentSum:Bm,SparseToDense:Xm,SplitV:yd,Sqrt:Vu,Square:Hm,SquaredDifference:Wu,StaticRegexReplace:xd,Step:Hu,StridedSlice:Km,StringNGrams:Zm,StringSplit:Ym,StringToHashBucketFast:jm,Sub:Uu,Sum:md,SymbolicTensor:Er,Tan:$u,Tanh:Bu,Tensor:It,TensorBuffer:bn,TensorScatterUpdate:zm,Tile:Xu,TopK:Qm,Transform:Jm,Transpose:io,Unique:qm,Unpack:vd,UnsortedSegmentSum:wd,UpperBound:CO,Variable:sh,ZerosLike:Sd,_FusedMatMul:Jc,abs:mn,acos:px,acosh:fx,add:me,addN:iR,all:rg,any:ih,argMax:yo,argMin:mx,asin:gx,asinh:yx,atan:bx,atan2:xx,atanh:vx,avgPool:Md,avgPool3d:Sx,backend:Zr,backend_util:K2,basicLSTMCell:aR,batchNorm:Ku,batchNorm2d:Tx,batchNorm3d:Ix,batchNorm4d:_x,batchToSpaceND:Cd,bincount:Mx,bitwiseAnd:oR,booleanMaskAsync:WR,broadcastArgs:lR,broadcastTo:ao,broadcast_util:nW,browser:mX,buffer:at,callbacks:epe,cast:Se,ceil:Cx,clipByValue:ws,clone:qr,complex:Ri,concat:ln,concat1d:Ex,concat2d:kx,concat3d:Nx,concat4d:Rx,constraints:jce,conv1d:ig,conv2d:Ai,conv2dTranspose:ag,conv3d:Lx,conv3dTranspose:Fx,copyRegisteredKernels:RO,cos:Ed,cosh:og,cosineWindow:Eg,cumprod:lh,cumsum:lg,customGrad:ii,data:Ufe,denseBincount:vf,deprecationWarn:hz,depthToSpace:Dx,depthwiseConv2d:Zu,deregisterOp:npe,device_util:iz,diag:uR,dilation2d:Px,disableDeprecationWarnings:cz,dispose:qe,disposeVariables:dz,div:ze,divNoNan:Gx,dot:Ox,dropout:cv,einsum:Za,elu:Yu,enableDebugMode:uz,enableProdMode:lz,enclosingPowerOfTwo:hv,engine:Ot,ensureShape:cR,env:ee,equal:Ls,erf:zx,euclideanNorm:Wx,exp:Ss,expandDims:zn,expm1:Ux,eye:ug,fft:Wd,fill:zo,findBackend:bz,findBackendFactory:xz,floor:Qu,floorDiv:sg,forceHalfFloat:xN,fused:KR,gather:Ju,gatherND:XR,gather_util:gX,getBackend:TM,getGradient:Pb,getKernel:nh,getKernelsForBackend:gf,gpgpu_util:N8,grad:OW,grads:zW,greater:ls,greaterEqual:Ui,ifft:Wl,imag:kd,image:or,inTopKAsync:HR,initializers:dhe,input:jR,io:Yw,irfft:Sg,isFinite:$x,isInf:Bx,isNaN:Xx,keep:on,kernel_impls:Xce,layers:Rde,leakyRelu:Nd,less:Gl,lessEqual:Ea,linalg:fv,linspace:hR,loadGraphModel:Cfe,loadGraphModelSync:Efe,loadLayersModel:n4,localResponseNormalization:Hx,log:Fs,log1p:Rd,logSigmoid:Kx,logSoftmax:hg,logSumExp:Ad,logicalAnd:lr,logicalNot:Ld,logicalOr:dg,logicalXor:Zx,losses:s2,lowerBound:dR,matMul:lt,math:Bce,max:Ks,maxPool:Fd,maxPool3d:Yx,maxPoolWithArgmax:pR,maximum:ci,mean:en,memory:bf,meshgrid:fR,metrics:Kde,min:Pl,minimum:ba,mirrorPad:jx,mod:Qx,model:phe,models:Zde,moments:Dd,movingAverage:UR,mul:B,multiRNNCell:mR,multinomial:gR,neg:Xt,nextFrame:$d,norm:ju,notEqual:wo,oneHot:Ol,ones:gs,onesLike:Ds,op:W,outerProduct:yR,pad:$i,pad1d:bR,pad2d:xR,pad3d:vR,pad4d:wR,pool:Jx,pow:Li,prelu:Gd,print:dx,prod:qx,profile:pz,raggedGather:SR,raggedRange:TR,raggedTensorToTensor:IR,rand:_R,randomGamma:ER,randomNormal:pg,randomStandardNormal:kR,randomUniform:ka,randomUniformInt:NR,range:So,ready:gz,real:zl,reciprocal:tv,registerBackend:ox,registerCallbackConstructor:mhe,registerGradient:rM,registerKernel:_s,registerOp:tpe,regularizers:Jde,relu:Lr,relu6:fg,removeBackend:yz,reshape:K,reverse:Zs,reverse1d:RR,reverse2d:AR,reverse3d:LR,reverse4d:FR,rfft:Ud,round:mg,rsqrt:gg,scalar:We,scatterND:$R,scatter_util:c$,searchSorted:gy,selu:yg,separableConv2d:bg,sequential:fhe,serialization:eX,setBackend:mz,setPlatform:vz,setWebGLContext:Sk,setdiff1dAsync:DR,shared:ik,sigmoid:Tr,sign:nv,signal:n2,sin:xg,sinh:vg,slice:vt,slice1d:Od,slice2d:wg,slice3d:zd,slice4d:Vl,slice_util:w2,softmax:Vd,softplus:Vo,spaceToBatchND:Pd,sparse:r2,sparseToDense:BR,spectral:t2,split:bs,sqrt:Bn,square:Ft,squaredDifference:Tg,squeeze:Na,stack:Qn,step:Uo,stridedSlice:sv,string:i2,sub:Ne,sum:Le,sumOutType:tg,tan:rv,tanh:xo,tensor:Yt,tensor1d:Un,tensor2d:ca,tensor3d:iv,tensor4d:PR,tensor5d:GR,tensor6d:OR,tensorScatterUpdate:zR,tensor_util:ez,test_util:hce,tidy:Y,tile:$s,time:fz,topk:ov,train:Xa,transpose:yt,truncatedNormal:_g,unique:lv,unregisterGradient:NO,unregisterKernel:kO,unsortedSegmentSum:Mg,unstack:Ys,upcastType:xs,upperBound:VR,util:UO,valueAndGrad:VW,valueAndGrads:WW,variable:uv,variableGrads:VM,version:Bfe,version_converter:aA,version_core:YR,version_cpu:gA,version_layers:ey,version_webgl:yA,webgl:Y6,webgl_util:P7,where:kn,whereAsync:Zw,zeros:gn,zerosLike:wt},Symbol.toStringTag,{value:"Module"})),bA=new it;bA.compose(new q,new Nr,new q(.001,.001,.001));const Hfe=new it().set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1);class xA{constructor({container:e,imageTargetSrc:t,maxTrack:s,uiLoading:r="yes",uiScanning:i="yes",uiError:a="yes",filterMinCF:o=null,filterBeta:l=null,warmupTolerance:u=null,missTolerance:c=null,userDeviceId:h=null,environmentDeviceId:d=null}){this.container=e,this.imageTargetSrc=t,this.maxTrack=s,this.filterMinCF=o,this.filterBeta=l,this.warmupTolerance=u,this.missTolerance=c,this.ui=new lO({uiLoading:r,uiScanning:i,uiError:a}),this.userDeviceId=h,this.environmentDeviceId=d,this.shouldFaceUser=!1,this.scene=new HS,this.cssScene=new HS,this.renderer=new P_({antialias:!0,alpha:!0}),this.cssRenderer=new Pue({antialias:!0}),this.renderer.outputEncoding=3001,this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new fs,this.anchors=[],this.renderer.domElement.style.position="absolute",this.cssRenderer.domElement.style.position="absolute",this.container.appendChild(this.renderer.domElement),this.container.appendChild(this.cssRenderer.domElement),window.addEventListener("resize",this.resize.bind(this))}async start(){this.ui.showLoading(),await this._startVideo(),await this._startAR()}stop(){this.controller.stopProcessVideo(),this.video.srcObject.getTracks().forEach(function(e){e.stop()}),this.video.remove()}switchCamera(){this.shouldFaceUser=!this.shouldFaceUser,this.stop(),this.start()}addAnchor(e){const t=new _i;t.visible=!1,t.matrixAutoUpdate=!1;const s={group:t,targetIndex:e,onTargetFound:null,onTargetLost:null,onTargetUpdate:null,css:!1,visible:!1};return this.anchors.push(s),this.scene.add(t),s}addCSSAnchor(e){const t=new _i;t.visible=!1,t.matrixAutoUpdate=!1;const s={group:t,targetIndex:e,onTargetFound:null,onTargetLost:null,onTargetUpdate:null,css:!0,visible:!1};return this.anchors.push(s),this.cssScene.add(t),s}_startVideo(){return new Promise((e,t)=>{if(this.video=document.createElement("video"),this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),this.video.setAttribute("playsinline",""),this.video.style.position="absolute",this.video.style.top="0px",this.video.style.left="0px",this.video.style.zIndex="-2",this.container.appendChild(this.video),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){this.ui.showCompatibility(),t();return}const s={audio:!1,video:{}};this.shouldFaceUser?this.userDeviceId?s.video.deviceId={exact:this.userDeviceId}:s.video.facingMode="user":this.environmentDeviceId?s.video.deviceId={exact:this.environmentDeviceId}:s.video.facingMode="environment",navigator.mediaDevices.getUserMedia(s).then(r=>{this.video.addEventListener("loadedmetadata",()=>{this.video.setAttribute("width",this.video.videoWidth),this.video.setAttribute("height",this.video.videoHeight),e()}),this.video.srcObject=r}).catch(r=>{console.log("getUserMedia error",r),t()})})}_startAR(){return new Promise(async(e,t)=>{const s=this.video;this.container,this.controller=new Lue({inputWidth:s.videoWidth,inputHeight:s.videoHeight,filterMinCF:this.filterMinCF,filterBeta:this.filterBeta,warmupTolerance:this.warmupTolerance,missTolerance:this.missTolerance,maxTrack:this.maxTrack,onUpdate:i=>{if(i.type==="updateMatrix"){const{targetIndex:a,worldMatrix:o}=i;for(let l=0;l<this.anchors.length;l++)if(this.anchors[l].targetIndex===a){if(this.anchors[l].css?this.anchors[l].group.children.forEach(u=>{u.element.style.visibility=o===null?"hidden":"visible"}):this.anchors[l].group.visible=o!==null,o!==null){let u=new it;u.elements=[...o],u.multiply(this.postMatrixs[a]),this.anchors[l].css&&u.multiply(bA),this.anchors[l].group.matrix=u}else this.anchors[l].group.matrix=Hfe;this.anchors[l].visible&&o===null&&(this.anchors[l].visible=!1,this.anchors[l].onTargetLost&&this.anchors[l].onTargetLost()),!this.anchors[l].visible&&o!==null&&(this.anchors[l].visible=!0,this.anchors[l].onTargetFound&&this.anchors[l].onTargetFound()),this.anchors[l].onTargetUpdate&&this.anchors[l].onTargetUpdate()}this.anchors.reduce((l,u)=>l||u.visible,!1)?this.ui.hideScanning():this.ui.showScanning()}}}),this.resize();const{dimensions:r}=await this.controller.addImageTargets(this.imageTargetSrc);this.postMatrixs=[];for(let i=0;i<r.length;i++){const a=new q,o=new Nr,l=new q,[u,c]=r[i];a.x=u/2,a.y=u/2+(c-u)/2,l.x=u,l.y=u,l.z=u;const h=new it;h.compose(a,o,l),this.postMatrixs.push(h)}await this.controller.dummyRun(this.video),this.ui.hideLoading(),this.ui.showScanning(),this.controller.processVideo(this.video),e()})}resize(){const{renderer:e,cssRenderer:t,camera:s,container:r,video:i}=this;if(!i)return;this.video.setAttribute("width",this.video.videoWidth),this.video.setAttribute("height",this.video.videoHeight);let a,o;const l=i.videoWidth/i.videoHeight,u=r.clientWidth/r.clientHeight;l>u?(o=r.clientHeight,a=o*l):(a=r.clientWidth,o=a/l);const c=this.controller.getProjectionMatrix(),h=this.controller.inputWidth/this.controller.inputHeight;let d;h>u?d=this.video.width/this.controller.inputWidth:d=this.video.height/this.controller.inputHeight;let p,f;h>u?(p=r.clientHeight,p*=d):(f=r.clientWidth,p=f/this.controller.inputWidth*this.controller.inputHeight,p*=d);let y=r.clientHeight/p;const g=2*Math.atan(1/c[5]*y)*180/Math.PI,m=c[14]/(c[10]-1),b=c[14]/(c[10]+1);c[5]/c[0],s.fov=g,s.near=m,s.far=b,s.aspect=r.clientWidth/r.clientHeight,s.updateProjectionMatrix(),i.style.top=-(o-r.clientHeight)/2+"px",i.style.left=-(a-r.clientWidth)/2+"px",i.style.width=a+"px",i.style.height=o+"px";const x=e.domElement,v=t.domElement;x.style.position="absolute",x.style.left=0,x.style.top=0,x.style.width=r.clientWidth+"px",x.style.height=r.clientHeight+"px",v.style.position="absolute",v.style.left=0,v.style.top=0,v.style.width=r.clientWidth+"px",v.style.height=r.clientHeight+"px",e.setSize(r.clientWidth,r.clientHeight),t.setSize(r.clientWidth,r.clientHeight)}}window.MINDAR||(window.MINDAR={});window.MINDAR.IMAGE||(window.MINDAR.IMAGE={});window.MINDAR.IMAGE.MindARThree=xA;window.MINDAR.IMAGE.tf=Xfe;function Kfe(n=!1){const e=document.getElementById("instructions");e&&(e.style.display="block",n&&setTimeout(()=>{e.style.display="none"},5e3))}function Zfe(){const n=document.getElementById("instructions");n&&(n.style.display="none")}function Yfe(){const n=document.getElementById("model-controls");n&&(n.style.display="block"),Kfe(!0)}function jfe(){const n=document.getElementById("model-controls");n&&(n.style.display="none"),Zfe()}let Qfe,Vr;const m_={rotationY:0,scale:1};function Cb(n){const e=document.getElementById("ar-frame");e&&(e.style.borderColor=n)}function g_(){const n=document.getElementById("ar-frame");n&&(n.style.display="block")}function Jfe(){const n=document.getElementById("ar-frame");n&&(n.style.display="none")}const xge=async n=>{if(!navigator.mediaDevices?.getUserMedia||!window.WebGLRenderingContext)return alert("Ваш браузер не поддерживает AR"),!1;!n||n.length;const e="./",t=new xA({container:document.querySelector("#ar-container"),imageTargetSrc:`${e}target.mind`,filterMinCF:1e-4,filterBeta:.01,missTolerance:10}),{renderer:s,scene:r,camera:i}=t;"outputColorSpace"in s&&(s.outputColorSpace=Je);const a=1,o=.5,l=new lG(16777215,4473924,a);r.add(l);const u=new _G,c={};(n||[]).forEach(d=>{c[d.markerIndex]===void 0&&(c[d.markerIndex]=d)});const h=[];try{for(const d of Object.values(c)){const f=(await u.loadAsync(d.url)).scene,y=new oi().setFromObject(f),g=new q;y.getSize(g);const m=Math.max(g.x,g.y,g.z),b=1;let x=o;Number.isFinite(m)&&m>0&&(x=b/m),f.scale.setScalar(x);const v=t.addAnchor(d.markerIndex??0);v.group.add(f),v.group.visible=!1,v.onTargetFound=()=>{v.group.visible=!0,Jfe(),Yfe(),Cb("green")},v.onTargetLost=()=>{v.group.visible=!1,g_(),jfe(),Cb("white")},h.push({anchor:v,model:f})}}catch(d){return console.error(d),alert("Ошибка загрузки 3D-модели!"),d?.message,!1}try{await t.start(),g_(),Cb("white");const d=t.video;Vr=document.createElement("canvas"),Vr.width=d.videoWidth,Vr.height=d.videoHeight,Vr.style.display="none",document.body.appendChild(Vr);const p=Vr.getContext("2d"),f=.5,y=1.5;Qfe=setInterval(()=>{p.drawImage(d,0,0,Vr.width,Vr.height);const{data:m}=p.getImageData(0,0,Vr.width,Vr.height);let b=0;for(let v=0;v<m.length;v+=4)b+=m[v]*.299+m[v+1]*.587+m[v+2]*.114;const x=b/(m.length/4)/255;l.intensity=kb.lerp(f,y,x)},500)}catch(d){return console.error(d),alert("Не удалось инициализировать камеру. Проверьте разрешения и перезагрузите страницу."),d?.message,!1}return s.setAnimationLoop(()=>{h.forEach(({model:d})=>{d.rotation.y=kb.degToRad(m_.rotationY),d.scale.setScalar(m_.scale)}),s.render(r,i)}),!0};export{m_ as modelParams,xge as startAR};
