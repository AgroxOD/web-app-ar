import"./style-BU8mkVOw.js";import{login as I,setAuth as p,register as v,logout as B,isAuthenticated as E,getRole as h}from"./auth-5C6X5tix.js";import{updateModel as L,loadModels as b,deleteModel as M}from"./models-BPT0YZdd.js";function x(n,t,d,s){const e=document.createElement("form");e.className="inline-form";const o=document.createElement("input");o.className="text-input",o.name="name",o.required=!0,o.value=d.name;const a=document.createElement("input");a.className="text-input",a.name="markerIndex",a.type="number",a.required=!0,a.value=d.markerIndex;const i=document.createElement("button");i.className="button button-primary",i.type="submit",i.textContent="Save";const l=document.createElement("button");return l.className="button",l.type="button",l.textContent="Cancel",e.append(o,a,i,l),l.addEventListener("click",()=>{e.remove(),s.disabled=!1}),e.addEventListener("submit",async w=>{w.preventDefault();try{await L(t,{name:e.name.value,markerIndex:parseInt(e.markerIndex.value,10)||0}),window.showMessage&&window.showMessage("Model updated"),window.refreshModels&&await window.refreshModels()}catch(f){if(window.showMessage){const y=f.message==="Forbidden"?"Permission denied":f.message;window.showMessage(y||"Update failed",!0)}}}),s.disabled=!0,n.appendChild(e),e}const k="";function r(n,t=!1){const d=document.getElementById("api-message");d.style.color=t?"red":"green",d.textContent=n,d.classList.remove("hidden")}window.showMessage=r;function u(){document.getElementById("api-message").classList.add("hidden")}async function m(){const n=document.getElementById("model-list");n.innerHTML="";const t=h()==="admin";try{const d=await b();u(),d.forEach(s=>{const e=s._id||s.id||s.url,o=document.createElement("li"),a=document.createElement("span");if(a.textContent=`${s.name} (${s.url}) marker: ${s.markerIndex}`,o.appendChild(a),t){const i=document.createElement("button");i.textContent="Edit",i.className="button button-secondary";const l=document.createElement("button");l.textContent="Delete",l.className="button",o.append(" ",i," ",l),i.addEventListener("click",()=>x(o,e,s,i)),l.addEventListener("click",()=>C(e))}n.appendChild(o)})}catch{r("Failed to load models",!0)}}window.refreshModels=m;async function C(n){if(confirm("Delete this model?"))try{await M(n),r("Model deleted"),await m()}catch(t){const d=t.message==="Forbidden"?"Permission denied":t.message;r(d||"Delete failed",!0)}}let g=!1;function c(){const n=E(),t=n&&h()==="admin",d=document.getElementById("login-form"),s=document.getElementById("register-form");n?(d.classList.add("hidden"),s.classList.add("hidden")):g?(d.classList.add("hidden"),s.classList.remove("hidden")):(d.classList.remove("hidden"),s.classList.add("hidden")),document.getElementById("logout").classList.toggle("hidden",!n),document.getElementById("upload-form").classList.toggle("hidden",!t);const e=document.getElementById("upload-message");t?(e.classList.add("hidden"),e.textContent=""):n?(e.textContent="Admin privileges required",e.classList.remove("hidden")):(e.textContent="Login required to upload models",e.classList.remove("hidden"))}document.getElementById("login-form").addEventListener("submit",async n=>{n.preventDefault();try{const{jwt:t}=await I(document.getElementById("login-email").value,document.getElementById("login-password").value);p(t),c(),await m(),u()}catch(t){r(t.message,!0)}});document.getElementById("register-form").addEventListener("submit",async n=>{n.preventDefault();try{const{jwt:t}=await v(document.getElementById("reg-username").value,document.getElementById("reg-email").value,document.getElementById("reg-password").value);p(t),c(),await m(),u()}catch(t){r(t.message,!0)}});document.getElementById("show-register").addEventListener("click",()=>{g=!0,c()});document.getElementById("show-login").addEventListener("click",()=>{g=!1,c()});document.getElementById("logout").addEventListener("click",()=>{B(),c(),document.getElementById("model-list").innerHTML="",u()});document.getElementById("upload-form").addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("file"),d=t.files[0];if(d&&d.size>10*1024*1024){r("File too large",!0);return}const s=new FormData;d&&s.append("model",d);try{const e={},o=localStorage.getItem("jwt");o&&(e.Authorization=`Bearer ${o}`);const a=await fetch(`${k}/upload`,{method:"POST",headers:e,body:s});if(a.status===403)throw new Error("Forbidden");if(!a.ok)throw new Error("Upload failed");t.value="",await m(),r("Upload successful")}catch(e){const o=e.message==="Forbidden"?"Permission denied":e.message;r(o||"Upload failed",!0)}});c();E()&&m();
