import"./style-Yv-X3phN.js";import{login as k,setAuth as E,register as x,logout as M,isAuthenticated as L,getRole as h}from"./auth-5C6X5tix.js";import{updateModel as C,loadModels as N,deleteModel as D}from"./models-BPT0YZdd.js";function F(e,o,a,d){const t=document.createElement("form");t.className="inline-form";const s=document.createElement("input");s.className="text-input",s.name="name",s.required=!0,s.value=a.name;const n=document.createElement("input");n.className="text-input",n.name="markerIndex",n.type="number",n.required=!0,n.value=a.markerIndex;const r=document.createElement("button");r.className="button button-primary",r.type="submit",r.textContent="Save";const c=document.createElement("button");return c.className="button",c.type="button",c.textContent="Cancel",t.append(s,n,r,c),c.addEventListener("click",()=>{t.remove(),d.disabled=!1}),t.addEventListener("submit",async b=>{b.preventDefault();try{await C(o,{name:t.name.value,markerIndex:parseInt(t.markerIndex.value,10)||0}),window.showMessage&&window.showMessage("Model updated"),window.refreshModels&&await window.refreshModels()}catch(f){if(window.showMessage){const B=f.message==="Forbidden"?"Permission denied":f.message;window.showMessage(B||"Update failed",!0)}}}),d.disabled=!0,e.appendChild(t),t}const g=document.getElementById("login-form"),p=document.getElementById("register-form"),I=document.getElementById("logout"),A=document.getElementById("show-register"),$=document.getElementById("show-login"),v=document.getElementById("upload-form"),S=document.getElementById("upload-section"),w=document.getElementById("models-list"),m=document.getElementById("message");let u=!1;function l(e,o=!1){m&&(m.textContent=e,m.className=o?"p-2 bg-red-200 text-red-800":"p-2 bg-green-200 text-green-800",e&&setTimeout(()=>{m.textContent="",m.className=""},4e3))}window.showMessage=l;function i(){const e=L();e?(g.style.display="none",p.style.display="none"):u?(g.style.display="none",p.style.display="flex"):(g.style.display="flex",p.style.display="none"),I.style.display=e?"inline-block":"none",S.style.display=e&&h()==="admin"?"block":"none"}g.addEventListener("submit",async e=>{e.preventDefault();try{const{jwt:o,role:a}=await k(document.getElementById("login-email").value,document.getElementById("login-password").value);E(o,a),u=!1,i()}catch(o){l(o.message,!0)}});p.addEventListener("submit",async e=>{e.preventDefault();try{const{jwt:o,role:a}=await x(document.getElementById("register-username").value,document.getElementById("register-email").value,document.getElementById("register-password").value);E(o,a),u=!1,i()}catch(o){l(o.message,!0)}});I.addEventListener("click",()=>{M(),i()});A.addEventListener("click",()=>{u=!0,i()});$.addEventListener("click",()=>{u=!1,i()});async function U(e){e.preventDefault();const o=document.getElementById("upload-file").files[0],a=document.getElementById("upload-marker").value||"0";if(!o)return;const d="",t=localStorage.getItem("jwt"),s=new FormData;s.append("model",o),s.append("markerIndex",a);try{const n=await fetch(`${d}/upload`,{method:"POST",headers:t?{Authorization:`Bearer ${t}`}:{},body:s}),r=await n.json().catch(()=>({}));if(!n.ok)throw new Error(r.error||`Upload failed: ${n.status}`);l("Uploaded"),v.reset(),await y()}catch(n){l(n.message,!0)}}v.addEventListener("submit",U);function j(e){w.innerHTML="";const o=h()==="admin";e.forEach(a=>{const d=a._id||a.id,t=document.createElement("li");if(t.textContent=`${a.name} (${a.url}) - marker ${a.markerIndex}`,o&&d){const s=document.createElement("button");s.textContent="Edit",s.className="button button-primary ml-2",s.addEventListener("click",()=>F(t,d,a,s)),t.appendChild(s);const n=document.createElement("button");n.textContent="Delete",n.className="button button-secondary ml-2",n.addEventListener("click",async()=>{if(confirm("Delete this model?"))try{await D(d),l("Model deleted"),await y()}catch(r){l(r.message,!0)}}),t.appendChild(n)}w.appendChild(t)})}async function y(){try{const e=await N();j(e)}catch(e){l(e.message||"Failed to load models",!0)}}window.refreshModels=y;i();y();
